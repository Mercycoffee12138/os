# Buddy System 物理内存管理器设计文档

## 1. 算法概述

Buddy System（伙伴系统）是一种经典的动态内存分配算法，它将内存划分为大小为2的幂次的块进行管理。本实现在uCore操作系统中提供了高效的物理页面分配和释放功能。

## 2. 设计原理

### 2.1 基本思想
- 系统内存被组织成大小为2^k页的块（k=0,1,2,...,MAX_ORDER）
- 维护多个空闲链表，每个链表管理特定大小的空闲块
- 分配时寻找合适大小的块，必要时进行分裂
- 释放时尝试与伙伴块合并，形成更大的空闲块

### 2.2 伙伴关系定义
两个块互为伙伴当且仅当：
1. 大小相同（都是2^k页）
2. 地址相邻
3. 起始地址较小的块的地址是块大小2倍的整数倍

### 2.3 数据结构

```c
#define MAX_ORDER 10  // 支持最大2^10=1024页的块

// 空闲链表数组，free_lists[i]管理大小为2^i页的空闲块
static free_area_t free_lists[MAX_ORDER + 1];
```

## 3. 核心算法实现

### 3.1 初始化 (buddy_init)
- 初始化所有空闲链表
- 清零空闲块计数器

### 3.2 内存映射初始化 (buddy_init_memmap)
- 将给定的内存区域按2的幂次分解
- 每个块加入对应大小的空闲链表
- 设置页面属性和标志位

### 3.3 页面分配 (buddy_alloc_pages)

**算法流程：**
1. 计算所需的最小阶数：order = ⌈log₂(n)⌉
2. 从order开始，向上搜索可用的空闲块
3. 找到合适块后，从空闲链表中移除
4. 如果块过大，递归分裂直到获得所需大小
5. 返回分配的页面

**分裂过程：**
```
原始块：[--------2^k--------]
分裂后：[--2^(k-1)--][--2^(k-1)--]
       (分配给用户)    (加入空闲链表)
```

### 3.4 页面释放 (buddy_free_pages)

**算法流程：**
1. 重置要释放的页面属性
2. 计算当前块的伙伴块
3. 如果伙伴块空闲且大小匹配，进行合并
4. 重复步骤2-3，直到无法继续合并
5. 将最终的块加入对应的空闲链表

**合并过程：**
```
释放前：[--A--] [--B--] (A和B互为伙伴)
合并后：[----A+B----]
```

### 3.5 伙伴查找算法 (get_buddy)
```c
static struct Page *get_buddy(struct Page *page, int order) {
    uintptr_t page_idx = page - pages;
    uintptr_t buddy_idx = page_idx ^ (1 << order);  // 异或运算找伙伴
    return pages + buddy_idx;
}
```

## 4. 关键特性

### 4.1 内存利用率
- 内部碎片：由于必须分配2的幂次大小，存在内部碎片
- 外部碎片：通过合并机制有效减少外部碎片

### 4.2 时间复杂度
- 分配：O(log n)，n为内存总页数
- 释放：O(log n)，最多进行log n次合并

### 4.3 空间复杂度
- O(log n)个空闲链表
- 每个页面需要额外的property字段存储块大小

## 5. 测试用例设计

### 5.1 基本功能测试
- 单页分配和释放
- 多页连续分配
- 交替分配释放模式

### 5.2 边界条件测试
- 分配超过最大块大小的内存
- 分配0页内存
- 在内存耗尽时的行为

### 5.3 算法特性测试
- 2的幂次大小分配
- 非2的幂次大小分配（验证向上取整）
- 连续分配后的碎片情况
- 合并机制验证

### 5.4 性能测试
- 大量小块分配性能
- 大块分配性能
- 分配释放混合场景

## 6. 与其他算法的比较

| 特性 | First Fit | Best Fit | Buddy System |
|------|-----------|----------|--------------|
| 查找时间 | O(n) | O(n) | O(log n) |
| 内部碎片 | 低 | 低 | 中等 |
| 外部碎片 | 高 | 中等 | 低 |
| 合并效率 | 低 | 低 | 高 |
| 实现复杂度 | 低 | 低 | 中等 |

## 7. 优化空间

### 7.1 可能的改进
1. **自适应阶数**：根据分配模式动态调整MAX_ORDER
2. **延迟合并**：批量释放时延迟合并操作
3. **内存预留**：为小块分配预留专门区域
4. **统计信息**：收集分配模式统计，优化分配策略

### 7.2 已知限制
1. 内部碎片不可避免
2. 不适合大量小块分配的场景
3. 需要额外的元数据存储空间

## 8. 总结

本Buddy System实现提供了：
- 高效的O(log n)分配和释放操作
- 自动的内存碎片整理机制
- 良好的内存局部性
- 完整的测试用例覆盖

该实现适合作为操作系统内核的基础内存管理器，特别是在需要频繁分配释放中等大小内存块的场景下表现优异。